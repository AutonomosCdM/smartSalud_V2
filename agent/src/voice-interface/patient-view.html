<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>smartSalud - Asistente de Voz</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px 30px;
      text-align: center;
    }

    .header {
      margin-bottom: 30px;
    }

    .logo {
      font-size: 64px;
      margin-bottom: 10px;
    }

    h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
      line-height: 1.5;
    }

    .appointment-info {
      background: #f7f9fc;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      color: #666;
      font-weight: 500;
    }

    .info-value {
      color: #333;
      font-weight: 600;
    }

    .voice-widget {
      margin: 30px 0;
      padding: 30px;
      background: #f7f9fc;
      border-radius: 12px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .loading {
      color: #667eea;
      font-size: 16px;
      font-weight: 500;
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success-message {
      background: #10b981;
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .error-message {
      background: #ef4444;
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .footer {
      margin-top: 30px;
      color: #999;
      font-size: 12px;
    }

    .manual-input {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .manual-input button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin: 5px;
    }

    .manual-input button:hover {
      background: #5568d3;
    }

    .manual-input button.cancel {
      background: #ef4444;
    }

    .manual-input button.cancel:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üè•</div>
      <h1>Asistente smartSalud</h1>
      <p class="subtitle">
        Habla con nuestro asistente de voz para reagendar tu cita m√©dica
      </p>
    </div>

    <div class="appointment-info" id="appointmentInfo" style="display: none;">
      <div class="info-row">
        <span class="info-label">Doctor:</span>
        <span class="info-value" id="doctorName">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">Especialidad:</span>
        <span class="info-value" id="specialty">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">Fecha Original:</span>
        <span class="info-value" id="originalDate">-</span>
      </div>
    </div>

    <div class="voice-widget" id="voiceWidget">
      <div class="spinner"></div>
      <p class="loading">Cargando asistente de voz...</p>
      <p style="color: #999; font-size: 14px; margin-top: 10px;">
        Por favor, permite el acceso al micr√≥fono cuando se solicite
      </p>
    </div>

    <div class="success-message" id="successMessage">
      <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
      <h2 style="margin-bottom: 10px;">¬°Gracias!</h2>
      <p id="successText">Tu solicitud ha sido procesada correctamente.</p>
    </div>

    <div class="error-message" id="errorMessage">
      <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
      <h2 style="margin-bottom: 10px;">Error</h2>
      <p id="errorText">No se pudo cargar el asistente de voz. Por favor, intenta nuevamente.</p>
    </div>

    <!-- Manual fallback if voice doesn't work -->
    <div class="manual-input" id="manualInput" style="display: none;">
      <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
        ¬øProblemas con el micr√≥fono? Selecciona una opci√≥n:
      </p>
      <button onclick="handleManualReschedule()">üìÖ Reagendar</button>
      <button onclick="handleManualCancel()" class="cancel">‚ùå Cancelar Cita</button>
    </div>

    <div class="footer">
      <p>smartSalud V3 - Sistema Aut√≥nomo de Gesti√≥n de Citas</p>
      <p>Powered by Cloudflare Agents & ElevenLabs</p>
    </div>
  </div>

  <script>
    // Parse URL parameters
    const params = new URLSearchParams(window.location.search);
    const workflowId = params.get('wfId');
    const appointmentId = params.get('aptId');
    const alternativesParam = params.get('alts');

    let alternatives = [];
    try {
      alternatives = alternativesParam ? JSON.parse(decodeURIComponent(alternativesParam)) : [];
    } catch (e) {
      console.error('Failed to parse alternatives:', e);
    }

    console.log('[VoiceInterface] Initialized', { workflowId, appointmentId, alternatives });

    // Show appointment info if available
    if (alternatives.length > 0 && alternatives[0].doctorName) {
      document.getElementById('appointmentInfo').style.display = 'block';
      document.getElementById('doctorName').textContent = alternatives[0].doctorName || '-';
      document.getElementById('specialty').textContent = alternatives[0].specialty || '-';
      document.getElementById('originalDate').textContent = alternatives[0].originalDateTime
        ? new Date(alternatives[0].originalDateTime).toLocaleString('es-CL')
        : '-';
    }

    // Initialize ElevenLabs voice interface
    // NOTE: This is a placeholder - actual ElevenLabs integration requires API key and agent ID
    async function initializeVoiceInterface() {
      try {
        // TODO: Replace with actual ElevenLabs Conversational AI initialization
        // const widget = new ElevenLabs.ConversationalAI({
        //   agentId: 'YOUR_ELEVENLABS_AGENT_ID',
        //   apiKey: 'YOUR_API_KEY',
        //   containerId: 'voiceWidget',
        //   context: {
        //     appointmentId,
        //     workflowId,
        //     alternatives,
        //   },
        // });

        // Simulate loading (remove when real integration is ready)
        setTimeout(() => {
          document.getElementById('voiceWidget').innerHTML = `
            <div style="color: #667eea; font-size: 48px; margin-bottom: 15px;">üé§</div>
            <p style="color: #333; font-weight: 600; margin-bottom: 10px;">
              Asistente de voz listo
            </p>
            <p style="color: #666; font-size: 14px;">
              Presiona el bot√≥n de micr√≥fono para hablar
            </p>
            <button onclick="startVoiceConversation()" style="
              background: #667eea;
              color: white;
              border: none;
              padding: 15px 30px;
              border-radius: 50px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              margin-top: 20px;
              transition: background 0.2s;
            ">
              üé§ Iniciar Conversaci√≥n
            </button>
          `;

          // Show manual fallback after 5 seconds
          setTimeout(() => {
            document.getElementById('manualInput').style.display = 'block';
          }, 5000);
        }, 2000);

      } catch (error) {
        console.error('[VoiceInterface] Initialization error:', error);
        showError('No se pudo cargar el asistente de voz. Por favor, intenta nuevamente m√°s tarde.');
      }
    }

    function startVoiceConversation() {
      alert('Integraci√≥n con ElevenLabs pendiente. Ver CLAUDE.md para instrucciones.');
      // TODO: Start ElevenLabs conversation
    }

    async function handleVoiceOutcome(outcome) {
      try {
        console.log('[VoiceInterface] Sending outcome:', outcome);

        const response = await fetch(`/agent/workflow/${workflowId}/voice-outcome`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            outcome: outcome.intent,
            selectedAlternative: outcome.selectedAlternative,
            transcript: outcome.transcript,
            duration: outcome.duration,
          }),
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('[VoiceInterface] Outcome sent successfully:', data);

        showSuccess(
          outcome.intent === 'rescheduled'
            ? 'Tu cita ha sido reagendada exitosamente'
            : outcome.intent === 'cancelled'
            ? 'Tu cita ha sido cancelada'
            : 'Tu solicitud ha sido procesada'
        );
      } catch (error) {
        console.error('[VoiceInterface] Failed to send outcome:', error);
        showError('No se pudo procesar tu solicitud. Por favor, contacta al centro m√©dico.');
      }
    }

    async function handleManualReschedule() {
      if (alternatives.length === 0) {
        alert('No hay alternativas disponibles en este momento.');
        return;
      }

      const message = 'Selecciona una alternativa:\n\n' +
        alternatives.map((alt, i) =>
          `${i + 1}. ${new Date(alt.dateTime).toLocaleString('es-CL')}`
        ).join('\n');

      const selection = prompt(message);
      const index = parseInt(selection) - 1;

      if (index >= 0 && index < alternatives.length) {
        await handleVoiceOutcome({
          intent: 'rescheduled',
          selectedAlternative: alternatives[index],
          transcript: 'Manual selection',
          duration: 0,
        });
      }
    }

    async function handleManualCancel() {
      if (confirm('¬øEst√°s seguro que deseas cancelar tu cita?')) {
        await handleVoiceOutcome({
          intent: 'cancelled',
          transcript: 'Manual cancellation',
          duration: 0,
        });
      }
    }

    function showSuccess(message) {
      document.getElementById('successText').textContent = message;
      document.getElementById('successMessage').classList.add('show');
      document.getElementById('voiceWidget').style.display = 'none';
      document.getElementById('manualInput').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('errorText').textContent = message;
      document.getElementById('errorMessage').classList.add('show');
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', initializeVoiceInterface);
  </script>
</body>
</html>
